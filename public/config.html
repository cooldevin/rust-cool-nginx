<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust-Cool-Nginx - æœåŠ¡å™¨é…ç½®</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .config-form {
            background: rgba(30, 30, 40, 0.7);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(20, 20, 30, 0.7);
            color: #fff;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .message {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
        }
        
        .message.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .message.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æœåŠ¡å™¨é…ç½®</h1>
            <p class="subtitle">ä»¥ä¸‹æ˜¯å½“å‰ Rust-Cool-Nginx æœåŠ¡å™¨çš„é…ç½®ä¿¡æ¯</p>
        </header>
        
        <div id="message" class="message hidden"></div>
        
        <div class="config-form">
            <h2 style="color: var(--primary); margin-bottom: 20px;">ä¿®æ”¹é…ç½®</h2>
            <form id="config-form">
                <div class="form-group">
                    <label for="listen_addr">ç›‘å¬åœ°å€:</label>
                    <input type="text" id="listen_addr" name="listen_addr" required>
                </div>
                
                <div class="form-group">
                    <label for="backend_addr">åç«¯åœ°å€ (ç•™ç©ºè¡¨ç¤ºé™æ€æ–‡ä»¶æœåŠ¡æ¨¡å¼):</label>
                    <input type="text" id="backend_addr" name="backend_addr">
                </div>
                
                <div class="form-group">
                    <label for="static_root">é™æ€æ–‡ä»¶æ ¹ç›®å½•:</label>
                    <input type="text" id="static_root" name="static_root" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="static_file_serving">é™æ€æ–‡ä»¶æœåŠ¡:</label>
                        <select id="static_file_serving" name="static_file_serving">
                            <option value="true">å¯ç”¨</option>
                            <option value="false">ç¦ç”¨</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reverse_proxy">åå‘ä»£ç†:</label>
                        <select id="reverse_proxy" name="reverse_proxy">
                            <option value="true">å¯ç”¨</option>
                            <option value="false">ç¦ç”¨</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="load_balancing">è´Ÿè½½å‡è¡¡:</label>
                        <select id="load_balancing" name="load_balancing">
                            <option value="true">å¯ç”¨</option>
                            <option value="false">ç¦ç”¨</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="load_balancing_algorithm">è´Ÿè½½å‡è¡¡ç®—æ³•:</label>
                        <select id="load_balancing_algorithm" name="load_balancing_algorithm">
                            <option value="round_robin">è½®è¯¢</option>
                            <option value="weighted_round_robin">åŠ æƒè½®è¯¢</option>
                            <option value="least_connections">æœ€å°‘è¿æ¥</option>
                            <option value="ip_hash">IPå“ˆå¸Œ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="upstream_servers">ä¸Šæ¸¸æœåŠ¡å™¨ (JSONæ ¼å¼):</label>
                    <textarea id="upstream_servers" name="upstream_servers"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="gzip_compression">Gzipå‹ç¼©:</label>
                        <select id="gzip_compression" name="gzip_compression">
                            <option value="true">å¯ç”¨</option>
                            <option value="false">ç¦ç”¨</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="gzip_comp_level">å‹ç¼©çº§åˆ« (1-9):</label>
                        <input type="number" id="gzip_comp_level" name="gzip_comp_level" min="1" max="9">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="access_control">è®¿é—®æ§åˆ¶:</label>
                        <select id="access_control" name="access_control">
                            <option value="true">å¯ç”¨</option>
                            <option value="false">ç¦ç”¨</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="rate_limiting">è¯·æ±‚é¢‘ç‡é™åˆ¶:</label>
                        <select id="rate_limiting" name="rate_limiting">
                            <option value="true">å¯ç”¨</option>
                            <option value="false">ç¦ç”¨</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="allow_ips">å…è®¸çš„IPåˆ—è¡¨ (JSONæ•°ç»„):</label>
                    <textarea id="allow_ips" name="allow_ips"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="deny_ips">æ‹’ç»çš„IPåˆ—è¡¨ (JSONæ•°ç»„):</label>
                    <textarea id="deny_ips" name="deny_ips"></textarea>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn">ä¿å­˜é…ç½®</button>
                    <button type="reset" class="btn btn-secondary">é‡ç½®</button>
                </div>
            </form>
        </div>
        
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">âš™ï¸</div>
                <h3 class="feature-title">æœåŠ¡å™¨é…ç½®</h3>
                <div class="config-section">
                    <div class="config-item">
                        <div class="config-key">ç›‘å¬åœ°å€:</div>
                        <div class="config-value" id="listen_addr_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">åç«¯åœ°å€:</div>
                        <div class="config-value" id="backend_addr_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">é™æ€æ–‡ä»¶æ ¹ç›®å½•:</div>
                        <div class="config-value" id="static_root_display">-</div>
                    </div>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">âš¡</div>
                <h3 class="feature-title">åŸºæœ¬ HTTP æœåŠ¡</h3>
                <div class="config-section">
                    <div class="config-item">
                        <div class="config-key">é™æ€æ–‡ä»¶æœåŠ¡:</div>
                        <div class="config-value" id="static_file_serving_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">åå‘ä»£ç†:</div>
                        <div class="config-value" id="reverse_proxy_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">FastCGI æ”¯æŒ:</div>
                        <div class="config-value" id="fastcgi_support_display">-</div>
                    </div>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">ğŸ›¡ï¸</div>
                <h3 class="feature-title">å®‰å…¨ç‰¹æ€§</h3>
                <div class="config-section">
                    <div class="config-item">
                        <div class="config-key">è®¿é—®æ§åˆ¶:</div>
                        <div class="config-value" id="access_control_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">è¯·æ±‚é¢‘ç‡é™åˆ¶:</div>
                        <div class="config-value" id="rate_limiting_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">SSL/TLS:</div>
                        <div class="config-value" id="ssl_tls_display">-</div>
                    </div>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">ğŸ”§</div>
                <h3 class="feature-title">å…¶ä»–åŠŸèƒ½</h3>
                <div class="config-section">
                    <div class="config-item">
                        <div class="config-key">è´Ÿè½½å‡è¡¡:</div>
                        <div class="config-value" id="load_balancing_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">ç¼“å­˜æœºåˆ¶:</div>
                        <div class="config-value" id="caching_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">Gzip å‹ç¼©:</div>
                        <div class="config-value" id="gzip_compression_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">è™šæ‹Ÿä¸»æœº:</div>
                        <div class="config-value" id="virtual_hosts_display">-</div>
                    </div>
                    <div class="config-item">
                        <div class="config-key">WebSocket æ”¯æŒ:</div>
                        <div class="config-value" id="websocket_support_display">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="actions">
            <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        </div>
        
        <footer>
            <p>Â© 2025 Rust-Cool-Nginx - é«˜æ€§èƒ½ Web æœåŠ¡å™¨ | åŸºäº Rust å’Œ Tokio æ„å»º</p>
        </footer>
    </div>
    
    <script>
        // é€šè¿‡APIè·å–å®é™…çš„é…ç½®ä¿¡æ¯
        function loadConfig() {
            fetch('/api/config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(config => {
                    // å¡«å……è¡¨å•
                    document.getElementById('listen_addr').value = config.server.listen_addr;
                    document.getElementById('backend_addr').value = config.server.backend_addr || '';
                    document.getElementById('static_root').value = config.server.static_root;
                    
                    document.getElementById('static_file_serving').value = config.features.static_file_serving.toString();
                    document.getElementById('reverse_proxy').value = config.features.reverse_proxy.toString();
                    document.getElementById('load_balancing').value = config.features.load_balancing.toString();
                    
                    if (config.upstream && config.upstream.load_balancing_algorithm) {
                        document.getElementById('load_balancing_algorithm').value = config.upstream.load_balancing_algorithm;
                    }
                    
                    if (config.upstream && config.upstream.servers) {
                        document.getElementById('upstream_servers').value = JSON.stringify(config.upstream.servers, null, 2);
                    }
                    
                    document.getElementById('gzip_compression').value = (config.features.gzip && config.features.gzip.gzip_compression || false).toString();
                    document.getElementById('gzip_comp_level').value = config.features.gzip && config.features.gzip.gzip_comp_level || 6;
                    
                    document.getElementById('access_control').value = (config.features.access_control && config.features.access_control.access_control || false).toString();
                    document.getElementById('rate_limiting').value = (config.features.access_control && config.features.access_control.rate_limiting || false).toString();
                    
                    if (config.features.access_control && config.features.access_control.allow_ips) {
                        document.getElementById('allow_ips').value = JSON.stringify(config.features.access_control.allow_ips, null, 2);
                    }
                    
                    if (config.features.access_control && config.features.access_control.deny_ips) {
                        document.getElementById('deny_ips').value = JSON.stringify(config.features.access_control.deny_ips, null, 2);
                    }
                    
                    // å¡«å……æ˜¾ç¤ºåŒºåŸŸ
                    document.getElementById('listen_addr_display').textContent = config.server.listen_addr;
                    document.getElementById('backend_addr_display').textContent = config.server.backend_addr || 'æ— ';
                    document.getElementById('static_root_display').textContent = config.server.static_root;
                    
                    const features = config.features;
                    const featureMapping = {
                        'static_file_serving_display': features.static_file_serving,
                        'reverse_proxy_display': features.reverse_proxy,
                        'fastcgi_support_display': features.fastcgi_support,
                        'load_balancing_display': features.load_balancing,
                        'caching_display': features.cache && features.cache.cache_enabled,
                        'gzip_compression_display': features.gzip && features.gzip.gzip_compression,
                        'virtual_hosts_display': features.virtual_hosts,
                        'access_control_display': features.access_control && features.access_control.access_control,
                        'rate_limiting_display': features.access_control && features.access_control.rate_limiting,
                        'ssl_tls_display': features.ssl_tls,
                        'websocket_support_display': features.websocket_support
                    };
                    
                    for (const [key, value] of Object.entries(featureMapping)) {
                        const element = document.getElementById(key);
                        if (element) {
                            element.textContent = value ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                            if (value) {
                                element.classList.add('enabled');
                            } else {
                                element.classList.add('disabled');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('è·å–é…ç½®ä¿¡æ¯å¤±è´¥:', error);
                    showMessage('åŠ è½½é…ç½®ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ', 'error');
                });
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 3000);
        }
        
        // æ— æ“ä½œå‡½æ•°
        function startConfigPolling() {
            // é…ç½®æ›´æ–°åä¼šç«‹å³åˆ·æ–°ï¼Œä¸éœ€è¦å®šæœŸè½®è¯¢
        }
        
        // ä¿å­˜é…ç½®
        function saveConfig(event) {
            event.preventDefault();
            
            // æ„å»ºé…ç½®å¯¹è±¡ï¼Œä¸¥æ ¼æŒ‰ç…§åç«¯æœŸæœ›çš„æ ¼å¼
            const formData = new FormData(document.getElementById('config-form'));
            
            // åˆ›å»ºåŸºç¡€é…ç½®å¯¹è±¡
            const config = {
                server: {
                    listen_addr: formData.get('listen_addr'),
                    backend_addr: formData.get('backend_addr'),
                    static_root: formData.get('static_root'),
                    access_log: "./logs/access.log",
                    error_log: "./logs/error.log",
                    log_level: "info",
                    ssl_cert_path: "./certs/server.crt",
                    ssl_key_path: "./certs/server.key",
                    ssl_enabled: false
                },
                upstream: {
                    load_balancing_algorithm: formData.get('load_balancing_algorithm') || "round_robin",
                    servers: []
                },
                features: {
                    static_file_serving: formData.get('static_file_serving') === 'true',
                    reverse_proxy: formData.get('reverse_proxy') === 'true',
                    fastcgi_support: false,
                    load_balancing: formData.get('load_balancing') === 'true',
                    // æ³¨æ„ï¼šä»¥ä¸‹å­—æ®µç”±äºä½¿ç”¨äº† #[serde(flatten)]ï¼Œéœ€è¦ç›´æ¥æ”¾åœ¨ features å¯¹è±¡ä¸­
                    cache_enabled: false,
                    cache_path: "./cache",
                    cache_max_size: "100M",
                    cache_inactive: "60m",
                    gzip_compression: formData.get('gzip_compression') === 'true',
                    gzip_comp_level: parseInt(formData.get('gzip_comp_level')) || 6,
                    gzip_min_length: 1024,
                    gzip_types: ["text/plain", "text/css", "application/json", "application/javascript", "text/xml", "application/xml"],
                    virtual_hosts: false,
                    access_control: formData.get('access_control') === 'true',
                    allow_ips: [],
                    deny_ips: [],
                    rate_limiting: formData.get('rate_limiting') === 'true',
                    max_requests_per_minute: 1000,
                    ssl_tls: false,
                    websocket_support: true,
                    worker_processes: 4,
                    worker_connections: 1024,
                    monitoring_enabled: true,
                    stats_path: "/nginx_status"
                }
            };
            
            // è§£æä¸Šæ¸¸æœåŠ¡å™¨é…ç½®
            try {
                if (formData.get('upstream_servers')) {
                    const serversValue = formData.get('upstream_servers').trim();
                    if (serversValue) {
                        config.upstream.servers = JSON.parse(serversValue);
                    }
                }
            } catch (e) {
                showMessage('ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®æ ¼å¼é”™è¯¯: ' + e.message, 'error');
                return;
            }
            
            // è§£æå…è®¸çš„IPåˆ—è¡¨
            try {
                if (formData.get('allow_ips')) {
                    const allowIpsValue = formData.get('allow_ips').trim();
                    if (allowIpsValue) {
                        config.features.allow_ips = JSON.parse(allowIpsValue);
                    }
                }
            } catch (e) {
                showMessage('å…è®¸çš„IPåˆ—è¡¨æ ¼å¼é”™è¯¯: ' + e.message, 'error');
                return;
            }
            
            // è§£ææ‹’ç»çš„IPåˆ—è¡¨
            try {
                if (formData.get('deny_ips')) {
                    const denyIpsValue = formData.get('deny_ips').trim();
                    if (denyIpsValue) {
                        config.features.deny_ips = JSON.parse(denyIpsValue);
                    }
                }
            } catch (e) {
                showMessage('æ‹’ç»çš„IPåˆ—è¡¨æ ¼å¼é”™è¯¯: ' + e.message, 'error');
                return;
            }
            
            // å‘é€æ›´æ–°è¯·æ±‚
            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error('Network response was not ok: ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showMessage('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    // é‡æ–°åŠ è½½é…ç½®ä»¥ç¡®è®¤æ›´æ–°
                    loadConfig();
                } else {
                    showMessage('é…ç½®ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showMessage('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('config-form').addEventListener('submit', saveConfig);
            
            // å¯åŠ¨é…ç½®è½®è¯¢
            startConfigPolling();
        });
    </script>
</body>
</html>